%% ===========================================
%% Nation-wise Failure Distribution - Top Conf Quality
%% Version 1
%% ===========================================

\documentclass[tikz,border=5pt]{standalone}
\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\usetikzlibrary{patterns, calc, positioning, arrows.meta}

\begin{document}

\begin{tikzpicture}
\begin{axis}[
    ybar stacked,
    bar width=20pt,
    width=12cm,
    height=8cm,
    ylabel={Proportion of Failures (\%)},
    xlabel={Nation},
    ymin=0,
    ymax=105,
    ytick={0,20,40,60,80,100},
    xtick=data,
    symbolic x coords={Japan, India, S.Korea, EU, Taiwan},
    x tick label style={font=\small\bfseries},
    y tick label style={font=\small},
    ylabel style={font=\small\bfseries},
    xlabel style={font=\small\bfseries},
    legend style={
        at={(0.5,-0.18)},
        anchor=north,
        legend columns=3,
        font=\footnotesize,
        /tikz/every even column/.append style={column sep=8pt},
        draw=none,
    },
    legend cell align={left},
    enlarge x limits=0.15,
    nodes near coords={\pgfmathprintnumber{\pgfplotspointmeta}\%},
    nodes near coords style={font=\tiny, text=black},
    every node near coord/.append style={yshift=0pt},
    point meta=explicit,
    clip=false,
    axis on top,
    grid=major,
    grid style={gray!20},
    major tick length=0pt,
]

% Non-Latin Script (orange)
\addplot+[
    ybar stacked,
    fill=orange!80,
    draw=orange!90!black,
    line width=0.5pt,
] coordinates {
    (Japan, 43.1) [43.1]
    (India, 56.3) [56.3]
    (S.Korea, 51.1) [51.1]
    (EU, 0) []
    (Taiwan, 14.3) [14.3]
};

% OCR/Text Recognition (yellow)
\addplot+[
    ybar stacked,
    fill=yellow!70,
    draw=yellow!90!black,
    line width=0.5pt,
] coordinates {
    (Japan, 4.6) []
    (India, 40.6) [40.6]
    (S.Korea, 10.6) []
    (EU, 24.0) [24.0]
    (Taiwan, 57.1) [57.1]
};

% Math/Symbol (purple)
\addplot+[
    ybar stacked,
    fill=violet!60,
    draw=violet!90!black,
    line width=0.5pt,
] coordinates {
    (Japan, 27.7) [27.7]
    (India, 3.1) []
    (S.Korea, 12.8) []
    (EU, 0) []
    (Taiwan, 0) []
};

% Pure Reasoning (blue)
\addplot+[
    ybar stacked,
    fill=blue!50,
    draw=blue!90!black,
    line width=0.5pt,
] coordinates {
    (Japan, 3.1) []
    (India, 0) []
    (S.Korea, 10.6) []
    (EU, 48.0) [48.0]
    (Taiwan, 14.3) []
};

% Others (gray)
\addplot+[
    ybar stacked,
    fill=gray!40,
    draw=gray!70,
    line width=0.5pt,
] coordinates {
    (Japan, 21.5) []
    (India, 0) []
    (S.Korea, 14.9) []
    (EU, 28.0) []
    (Taiwan, 14.3) []
};

\legend{Non-Latin Script, OCR/Text, Math/Symbol, Pure Reasoning, Others}

% Sample size annotations
\node[below, font=\scriptsize, gray] at (axis cs:Japan, -3) {(n=65)};
\node[below, font=\scriptsize, gray] at (axis cs:India, -3) {(n=32)};
\node[below, font=\scriptsize, gray] at (axis cs:S.Korea, -3) {(n=47)};
\node[below, font=\scriptsize, gray] at (axis cs:EU, -3) {(n=25)};
\node[below, font=\scriptsize, gray] at (axis cs:Taiwan, -3) {(n=7)};

% Bottleneck annotations with braces
\draw[decorate, decoration={brace, amplitude=8pt, raise=2pt}, thick, orange!80!black]
    (axis cs:Japan, 102) -- (axis cs:S.Korea, 102)
    node[midway, above=10pt, font=\small\bfseries, orange!80!black] {Perception Bottleneck};

\draw[decorate, decoration={brace, amplitude=5pt, raise=2pt}, thick, blue!80!black]
    (axis cs:EU, 102) -- (axis cs:EU, 102)
    node[midway, above=8pt, font=\small\bfseries, blue!80!black] {Reasoning Bottleneck};

\end{axis}
\end{tikzpicture}

\end{document}
